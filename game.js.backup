// Fate Keys å‘½é‹ç¯€å¥ - ä¸»è¦éŠæˆ²é‚è¼¯
// ===============================

// ===============================
// éŸ³è¨Šç®¡ç†å™¨ (Audio Manager)
// ===============================
const audioManager = {
    // éŸ³è¨Šå¯¦ä¾‹
    bgmAudio: null,        // èƒŒæ™¯éŸ³æ¨‚ (Drive.mp3)
    previewAudio: null,    // é è¦½éŸ³æ¨‚
    gameAudio: null,       // éŠæˆ²éŸ³æ¨‚
    
    // ç•¶å‰ç‹€æ…‹
    currentPreviewSong: null,
    isBgmPlaying: false,
    isPreviewPlaying: false,
    isGamePlaying: false,
    
    // é˜²æŠ–æ©Ÿåˆ¶
    previewTimeout: null,
    
    // éŸ³è¨Šè·¯å¾‘è¨­å®š
    audioPaths: {
        bgm: 'DRIVE.mp3',
        songs: {
            'Champion.mp3': 'Champion.mp3',
            'Bliss.mp3': 'Bliss.mp3',
            'Canon.mp3': 'Canon.mp3',
            'HappyBirthday.mp3': 'HappyBirthday.mp3',
            'MainTheme.mp3': 'MainTheme.mp3',
            'MagicalMoments.mp3': 'MagicalMoments.mp3',
            'Noise.mp3': 'Noise.mp3',
            'HammerMASTER.mp3': 'HammerMASTER.mp3',
            'InspiringDreams.mp3': 'InspiringDreams.mp3',
            'inspiringguitar.mp3': 'inspiringguitar.mp3'
        }
    },
    
    /**
     * åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚
     */
    initBgm() {
        try {
            this.bgmAudio = new Audio(this.audioPaths.bgm);
            this.bgmAudio.loop = true;
            this.bgmAudio.volume = 0.5;
            console.log('ğŸµ èƒŒæ™¯éŸ³æ¨‚åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('âŒ èƒŒæ™¯éŸ³æ¨‚åˆå§‹åŒ–å¤±æ•—:', error);
        }
    },
    
    /**
     * æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
     */
    playBgm() {
        if (!this.bgmAudio) {
            this.initBgm();
        }
        
        if (this.bgmAudio && this.bgmAudio.paused) {
            this.bgmAudio.play()
                .then(() => {
                    this.isBgmPlaying = true;
                    console.log('ğŸµ èƒŒæ™¯éŸ³æ¨‚é–‹å§‹æ’­æ”¾');
                })
                .catch(error => {
                    if (error.name === 'NotAllowedError') {
                        console.log('âš ï¸ éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾éŸ³æ¨‚ï¼Œè«‹é»æ“Šç•«é¢');
                    } else {
                        console.error('âŒ èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', error);
                    }
                    this.isBgmPlaying = false;
                });
        }
    },
    
    /**
     * åœæ­¢èƒŒæ™¯éŸ³æ¨‚
     */
    stopBgm() {
        if (this.bgmAudio && !this.bgmAudio.paused) {
            this.bgmAudio.pause();
            this.bgmAudio.currentTime = 0;
            this.isBgmPlaying = false;
            console.log('ğŸ”‡ èƒŒæ™¯éŸ³æ¨‚å·²åœæ­¢');
        }
    },
    
    /**
     * æ’­æ”¾é è¦½éŸ³æ¨‚ï¼ˆå¸¶é˜²æŠ–æ©Ÿåˆ¶ï¼‰
     * @param {string} songName - æ­Œæ›²æª”æ¡ˆåç¨±
     */
    playPreview(songName) {
        // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–è¨ˆæ™‚å™¨
        if (this.previewTimeout) {
            clearTimeout(this.previewTimeout);
        }
        
        // å¦‚æœå·²ç¶“åœ¨é è¦½åŒä¸€é¦–æ­Œï¼Œä¸é‡è¤‡æ’­æ”¾
        if (this.currentPreviewSong === songName && this.isPreviewPlaying) {
            return;
        }
        
        // ç«‹å³åœæ­¢ç•¶å‰é è¦½
        this.stopPreview();
        
        // é˜²æŠ–ï¼šå»¶é² 100ms å†æ’­æ”¾ï¼Œé¿å…å¿«é€Ÿåˆ‡æ›é€ æˆçš„ AbortError
        this.previewTimeout = setTimeout(() => {
            // åœæ­¢èƒŒæ™¯éŸ³æ¨‚
            this.stopBgm();
            
            try {
                const songPath = this.audioPaths.songs[songName];
                if (!songPath) {
                    console.error('âŒ æ‰¾ä¸åˆ°æ­Œæ›²:', songName);
                    return;
                }
                
                this.previewAudio = new Audio(songPath);
                
                // è¨­å®šéŸ³é‡ï¼šå¡è¾²ç‰¹åˆ¥å¤§è²
                if (songName === 'Canon.mp3') {
                    this.previewAudio.volume = 0.8;
                } else {
                    this.previewAudio.volume = 0.6;
                }
                
                // è¨­å®šé è¦½èµ·å§‹é»ï¼šå¡è¾²å¾10ç§’é–‹å§‹
                if (songName === 'Canon.mp3') {
                    this.previewAudio.currentTime = 10; // å¡è¾²å¾10ç§’é–‹å§‹
                } else {
                    this.previewAudio.currentTime = 10; // å…¶ä»–æ­Œæ›²å¾10ç§’é–‹å§‹
                }
                
                this.previewAudio.play()
                    .then(() => {
                        this.currentPreviewSong = songName;
                        this.isPreviewPlaying = true;
                        console.log(`ğŸµ é è¦½éŸ³æ¨‚é–‹å§‹æ’­æ”¾: ${songName}`);
                    })
                    .catch(error => {
                        // å¿½ç•¥ AbortErrorï¼ˆæ’­æ”¾è¢«ä¸­æ–·ï¼‰
                        if (error.name === 'AbortError') {
                            console.log(`ğŸ”‡ é è¦½éŸ³æ¨‚æ’­æ”¾è¢«ä¸­æ–·: ${songName}`);
                        } else if (error.name === 'NotAllowedError') {
                            console.log('âš ï¸ éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾é è¦½éŸ³æ¨‚');
                            // æ¢å¾©èƒŒæ™¯éŸ³æ¨‚
                            this.playBgm();
                        } else {
                            console.error('âŒ é è¦½éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', error);
                            this.playBgm();
                        }
                    });
            } catch (error) {
                console.error('âŒ é è¦½éŸ³æ¨‚åˆå§‹åŒ–å¤±æ•—:', error);
                this.playBgm();
            }
        }, 100);
    },
    
    /**
     * åœæ­¢é è¦½éŸ³æ¨‚
     */
    stopPreview() {
        if (this.previewAudio) {
            try {
                this.previewAudio.pause();
                this.previewAudio.currentTime = 0;
                this.previewAudio = null;
            } catch (error) {
                // å¿½ç•¥åœæ­¢æ™‚çš„éŒ¯èª¤
                console.log('ğŸ”‡ é è¦½éŸ³æ¨‚åœæ­¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼ˆå¯å¿½ç•¥ï¼‰');
            }
        }
        this.currentPreviewSong = null;
        this.isPreviewPlaying = false;
        console.log('ğŸ”‡ é è¦½éŸ³æ¨‚å·²åœæ­¢');
    },
    
    /**
     * æ’­æ”¾éŠæˆ²éŸ³æ¨‚
     * @param {string} songName - æ­Œæ›²æª”æ¡ˆåç¨±
     * @param {number} offsetSec - æ’­æ”¾èµ·å§‹ç§’æ•¸
     * @param {Function} onStart - æ’­æ”¾é–‹å§‹å›èª¿
     */
    playGameMusic(songName, offsetSec = 0, onStart = null) {
        // åœæ­¢æ‰€æœ‰å…¶ä»–éŸ³æ¨‚
        this.stopBgm();
        this.stopPreview();
        
        try {
            const songPath = this.audioPaths.songs[songName];
            if (!songPath) {
                console.error('âŒ æ‰¾ä¸åˆ°éŠæˆ²æ­Œæ›²:', songName);
                if (onStart) onStart();
                return;
            }
            
            this.gameAudio = new Audio(songPath);
            
            // è¨­å®šéŸ³é‡ï¼šå¡è¾²ç‰¹åˆ¥å¤§è²
            if (songName === 'Canon.mp3') {
                this.gameAudio.volume = 0.9;
            } else {
                this.gameAudio.volume = 0.8;
            }
            
            this.gameAudio.currentTime = offsetSec;
            
            // è¨­å®šçµæŸäº‹ä»¶
            if (songName === 'HappyBirthday.mp3') {
                this.gameAudio.onended = () => {
                    // ç”Ÿæ—¥å¿«æ¨‚æ­Œå¾ªç’°æ’­æ”¾
                    this.playGameMusic(songName, offsetSec, onStart);
                };
            } else {
                this.gameAudio.onended = () => {
                    // éŠæˆ²çµæŸ
                    if (typeof endGame === 'function') {
                        endGame();
                    }
                };
            }
            
            this.gameAudio.play()
                .then(() => {
                    this.isGamePlaying = true;
                    console.log(`ğŸ® éŠæˆ²éŸ³æ¨‚é–‹å§‹æ’­æ”¾: ${songName} (å¾ ${offsetSec}s é–‹å§‹)`);
                    if (onStart) onStart();
                })
                .catch(error => {
                    if (error.name === 'NotAllowedError') {
                        console.log('âš ï¸ éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾éŠæˆ²éŸ³æ¨‚');
                    } else {
                        console.error('âŒ éŠæˆ²éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', error);
                    }
                    this.isGamePlaying = false;
                    if (onStart) onStart();
                });
        } catch (error) {
            console.error('âŒ éŠæˆ²éŸ³æ¨‚åˆå§‹åŒ–å¤±æ•—:', error);
            this.isGamePlaying = false;
            if (onStart) onStart();
        }
    },
    
    /**
     * åœæ­¢éŠæˆ²éŸ³æ¨‚
     */
    stopGameMusic() {
        if (this.gameAudio) {
            try {
                this.gameAudio.pause();
                this.gameAudio.currentTime = 0;
                this.gameAudio = null;
            } catch (error) {
                // å¿½ç•¥åœæ­¢æ™‚çš„éŒ¯èª¤
                console.log('ğŸ”‡ éŠæˆ²éŸ³æ¨‚åœæ­¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼ˆå¯å¿½ç•¥ï¼‰');
            }
        }
        this.isGamePlaying = false;
        console.log('ğŸ”‡ éŠæˆ²éŸ³æ¨‚å·²åœæ­¢');
    },
    
    /**
     * åœæ­¢æ‰€æœ‰éŸ³æ¨‚
     */
    stopAll() {
        this.stopBgm();
        this.stopPreview();
        this.stopGameMusic();
        console.log('ğŸ”‡ æ‰€æœ‰éŸ³æ¨‚å·²åœæ­¢');
    },
    
    /**
     * æ¢å¾©èƒŒæ™¯éŸ³æ¨‚ï¼ˆç”¨æ–¼éŠæˆ²çµæŸå¾Œï¼‰
     */
    resumeBgm() {
        this.stopGameMusic();
        this.stopPreview();
        this.playBgm();
    }
};

// å–å¾— DOM å…ƒç´ 
const gameArea = document.getElementById('game-area');
const resultScreen = document.getElementById('result-screen');
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
const keyHints = document.querySelectorAll('.key');
const scoreDisplay = document.getElementById('score-display');
const comboDisplay = document.getElementById('combo-display');
const finalScore = document.getElementById('final-score');
const finalGrade = document.getElementById('final-grade');
const restartBtn = document.getElementById('restart-btn');
const backBtn = document.getElementById('back-btn');
const selectArea = document.getElementById('select-area');
const songSelect = document.getElementById('song');
const startBtn = document.getElementById('start-btn');
const difficultyBtns = document.querySelectorAll('.difficulty-btn');
const songCards = document.querySelectorAll('.song-card');
const confirmBtn = document.getElementById('confirm-btn');

// éŠæˆ²è¨­å®š
const KEY_LIST = ['A', 'S', 'D', 'F', 'G'];
const KEY_COLORS = ['#ff6f91', '#4ecdc4', '#ffe066', '#5f6fff', '#ffb347'];
let currentDifficulty = null; // ä¸€é–‹å§‹ä¸é¸é›£åº¦
let selectedSong = null; // ä¸€é–‹å§‹ä¸é¸æ­Œæ›²
let gamePlayCount = 0; // éŠæˆ²æ¬¡æ•¸è¿½è¹¤

// é›£åº¦è¨­å®šç‰©ä»¶
const difficultySettings = {
    easy: {
        name: "ğŸµ å…¥é–€æ¼”å¥ Beginner",
        noteSpeed: 1.6,
        judgementRange: 150,
        minNoteGap: 800,
        allowChords: false,
        perfectScore: 500,
        goodScore: 200,
        missScore: 0
    },
    normal: {
        name: "ğŸ¶ åŸºç¤æ¼”å¥ Intermediate",
        noteSpeed: 1.2,
        judgementRange: 100,
        minNoteGap: 600,
        allowChords: true,
        perfectScore: 500,
        goodScore: 200,
        missScore: 0
    },
    hard: {
        name: "ğŸ¼ é«˜ç´šæ¼”å¥ Advanced",
        noteSpeed: 0.9,
        judgementRange: 75,
        minNoteGap: 400,
        allowChords: true,
        perfectScore: 500,
        goodScore: 200,
        missScore: 0
    },
    master: {
        name: "ğŸ¹ å‘½é‹ç¨å¥ Fate Solo",
        noteSpeed: 0.6,
        judgementRange: 50,
        minNoteGap: 250,
        allowChords: true,
        perfectScore: 500,
        goodScore: 200,
        missScore: 0
    },
    final: {
        name: "ğŸŒŸ çµ‚æ¥µå¹»æƒ³ Final Encore",
        noteSpeed: 0.4,
        judgementRange: 30,
        minNoteGap: 200,
        allowChords: true,
        perfectScore: 500,
        goodScore: 200,
        missScore: 0
    }
};

// éŠæˆ²æ™‚é•·ï¼ˆçµ±ä¸€60ç§’ï¼‰
const GAME_SECONDS = 60;

// éŠæˆ²ç‹€æ…‹
let notes = [];
let currentNoteIndex = 0;
let startTime = 0;
let score = 0;
let combo = 0;
let maxCombo = 0;
let isPlaying = false;
let animationId = null;
let endTimer = null;
let timerInterval = null;

// ===============================
// ç•«é¢åˆ‡æ›
// ===============================
function showScreen(screen) {
    // å…ˆéš±è—æ‰€æœ‰ç•«é¢
    if (gameArea) gameArea.style.display = 'none';
    if (resultScreen) resultScreen.style.display = 'none';
    if (selectArea) selectArea.style.display = 'none';
    
    // é¡¯ç¤ºæŒ‡å®šç•«é¢
    if (screen === 'game' && gameArea) {
        gameArea.style.display = 'flex';
        // é‡æ–°èª¿æ•´ Canvas å¤§å°
        resizeCanvas();
    } else if (screen === 'result' && resultScreen) {
        resultScreen.style.display = 'flex';
    } else if (screen === 'select' && selectArea) {
        selectArea.style.display = 'flex';
    }
}

// ===============================
// ç”¢ç”ŸéŸ³ç¬¦é™£åˆ—ï¼ˆæ”¯æ´è¤‡éŸ³èˆ‡é–“è·æ§åˆ¶ï¼‰
// ===============================
function generateNotes(difficulty, duration = 60) {
    const settings = difficultySettings[difficulty];
    const notes = [];
    const minInterval = settings.minNoteGap / 1000; // è½‰æ›ç‚ºç§’
    const allowChords = settings.allowChords;
    
    let currentTime = 0;
    let lastNoteTime = -minInterval; // ç¢ºä¿ç¬¬ä¸€é¡†éŸ³ç¬¦å¯ä»¥ç«‹å³å‡ºç¾
    
    while (currentTime < duration) {
        // æ±ºå®šé€™æ¬¡è¦ç”¢ç”Ÿå¹¾å€‹éŸ³ç¬¦ï¼ˆè¤‡éŸ³ï¼‰
        let noteCount = 1;
        if (allowChords && Math.random() < 0.3) { // 30% æ©Ÿç‡ç”¢ç”Ÿè¤‡éŸ³
            noteCount = Math.min(3, Math.floor(Math.random() * 3) + 1); // æœ€å¤š3å€‹éŸ³ç¬¦åŒæ™‚
        }
        
        // ç”¢ç”ŸéŸ³ç¬¦
        const lanes = [];
        for (let i = 0; i < noteCount; i++) {
            let lane;
            if (i === 0) {
                // ç¬¬ä¸€å€‹éŸ³ç¬¦ï¼šé¿å…èˆ‡ä¸Šä¸€æ¬¡ç›¸åŒ
                const availableLanes = [0, 1, 2, 3, 4].filter(l => l !== (notes.length > 0 ? notes[notes.length - 1].lane : -1));
                lane = availableLanes[Math.floor(Math.random() * availableLanes.length)];
            } else {
                // è¤‡éŸ³éŸ³ç¬¦ï¼šé¿å…èˆ‡åŒçµ„å…¶ä»–éŸ³ç¬¦ç›¸åŒ
                const availableLanes = [0, 1, 2, 3, 4].filter(l => !lanes.includes(l));
                lane = availableLanes[Math.floor(Math.random() * availableLanes.length)];
            }
            lanes.push(lane);
            
            notes.push({
                time: currentTime,
                lane: lane,
                hit: false,
                anim: 0,
                polyphonyGroup: currentTime // ç”¨æ–¼è­˜åˆ¥åŒçµ„è¤‡éŸ³
            });
        }
        
        // è¨ˆç®—ä¸‹ä¸€å€‹éŸ³ç¬¦çš„æ™‚é–“
        const baseInterval = minInterval;
        const randomVariation = Math.random() * 0.5 + 0.75; // 0.75-1.25 å€éš¨æ©Ÿè®ŠåŒ–
        const nextInterval = baseInterval * randomVariation;
        
        currentTime += nextInterval;
    }
    
    // æŒ‰æ™‚é–“æ’åº
    notes.sort((a, b) => a.time - b.time);
    
    return notes;
}

// ===============================
// éŠæˆ²é–‹å§‹èˆ‡é‡å•Ÿ
// ===============================
if (restartBtn) restartBtn.addEventListener('click', () => {
    // åªé‡è¨­éŠæˆ²ç‹€æ…‹ï¼Œä¸é‡è¨­é¸æ“‡ï¼Œç›´æ¥é‡æ–°é–‹å§‹
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    if (endTimer) {
        clearTimeout(endTimer);
        endTimer = null;
    }
    // åœæ­¢æ‰€æœ‰éŸ³æ¨‚
    audioManager.stopAll();
    // ä½¿ç”¨ showScreen å‡½æ•¸æ­£ç¢ºåˆ‡æ›ç•«é¢
    showScreen('game');
    setTimeout(() => startGame(), 1000);
});
if (backBtn) backBtn.addEventListener('click', () => {
    // ä½¿ç”¨ showScreen å‡½æ•¸æ­£ç¢ºåˆ‡æ›ç•«é¢
    showScreen('select');
    // åœæ­¢è©¦è½éŸ³æ¨‚ï¼Œæ¢å¾©èƒŒæ™¯éŸ³æ¨‚
    audioManager.stopPreview();
});
if (startBtn) startBtn.addEventListener('click', () => {
    if (!selectedSong || !currentDifficulty) return;
    startGame();
});

// éŸ¿æ‡‰å¼ Canvas ç•«é¢æ¯”ä¾‹èª¿æ•´
function resizeCanvas() {
    // ä»¥ 3:4 æ¯”ä¾‹è‡ªå‹•ç¸®æ”¾ï¼Œæœ€å¤§ 480x640
    let w = Math.min(window.innerWidth * 0.98, 480);
    let h = w * 4 / 3;
    if (h > window.innerHeight * 0.8) {
        h = window.innerHeight * 0.8;
        w = h * 3 / 4;
    }
    canvas.width = w;
    canvas.height = h;
}
window.addEventListener('resize', resizeCanvas);

function startGame() {
    // åœæ­¢æ‰€æœ‰éŸ³æ¨‚ï¼Œé–‹å§‹éŠæˆ²éŸ³æ¨‚
    audioManager.stopAll();
    
    notes = generateNotes(currentDifficulty, GAME_SECONDS); // ç”¢ç”ŸéŸ³ç¬¦
    currentNoteIndex = 0;
    score = 0;
    combo = 0;
    maxCombo = 0;
    isPlaying = true;
    scoreDisplay.textContent = 'åˆ†æ•¸ï¼š0';
    comboDisplay.textContent = '';
    showScreen('game');
    resizeCanvas();
    
    // è¨­å®šè¨ˆæ™‚å™¨
    let remain = GAME_SECONDS;
    const timerDisplay = document.getElementById('timer-display');
    if (timerInterval) clearInterval(timerInterval);
    if (timerDisplay) timerDisplay.textContent = `å‰©é¤˜ï¼š${remain.toFixed(1)} ç§’`;
    timerInterval = setInterval(() => {
        if (!isPlaying) return;
        remain -= 0.1;
        if (remain < 0) remain = 0;
        if (timerDisplay) timerDisplay.textContent = `å‰©é¤˜ï¼š${remain.toFixed(1)} ç§’`;
    }, 100);
    
    // è¨­å®šéŠæˆ²éŸ³æ¨‚æ’­æ”¾èµ·å§‹é»
    let offsetSec = 10; // æ‰€æœ‰æ­Œæ›²éƒ½å¾10ç§’é–‹å§‹æ’­æ”¾
    
    // ä½¿ç”¨ audioManager æ’­æ”¾éŠæˆ²éŸ³æ¨‚
    audioManager.playGameMusic(selectedSong, offsetSec, () => {
        // éŸ³æ¨‚çœŸæ­£é–‹å§‹æ’­æ”¾æ™‚æ‰è¨­å®š startTimeï¼Œç¢ºä¿éŸ³ç¬¦èˆ‡éŸ³æ¨‚åŒæ­¥
        startTime = performance.now();
        animationId = requestAnimationFrame(gameLoop);
        if (endTimer) clearTimeout(endTimer);
        endTimer = setTimeout(() => {
            endGame();
        }, GAME_SECONDS * 1000);
    });
}

// ===============================
// Canvas å‹•ç•«ä¸»è¿´åœˆ
// ===============================
function gameLoop(now) {
    if (!isPlaying) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground(now);
    drawNotes(now);
    animationId = requestAnimationFrame(gameLoop);
}

function drawBackground(now) {
    for (let i = 0; i < 30; i++) {
        const x = (now / 10 + i * 50) % canvas.width;
        const y = (now / 5 + i * 80) % canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 2 + (i % 3), 0, 2 * Math.PI);
        ctx.fillStyle = i % 2 === 0 ? '#4ecdc4' : '#ffb347';
        ctx.globalAlpha = 0.18;
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

function drawNotes(now) {
    const elapsed = (now - startTime) / 1000;
    const settings = difficultySettings[currentDifficulty];
    const laneWidth = canvas.width / KEY_LIST.length;
    const noteHeight = 32;
    for (let i = currentNoteIndex; i < notes.length; i++) {
        const note = notes[i];
        if (note.hit && note.anim >= 1) continue; // å‹•ç•«çµæŸæ‰æ¶ˆå¤±
        const dropTime = note.time; // ç«‹å³è½ä¸‹
        const y = (elapsed - dropTime) * (180 / settings.noteSpeed) + 60;
        if (y + noteHeight/2 > canvas.height) continue; // åªæœ‰éŸ³ç¬¦åº•éƒ¨è¶…éç•«é¢åº•ç«¯æ‰æ¶ˆå¤±
        if (y < -noteHeight) continue;
        let scale = 1;
        if (note.hit && note.anim < 1) {
            scale = 1 - note.anim;
            note.anim += 0.08;
        }
        ctx.save();
        ctx.translate(note.lane * laneWidth + laneWidth / 2, y + noteHeight / 2);
        ctx.scale(scale, scale);
        ctx.fillStyle = KEY_COLORS[note.lane];
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(-laneWidth/2 + 10, -noteHeight/2, laneWidth - 20, noteHeight, 10);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
    }
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - 100);
    ctx.lineTo(canvas.width, canvas.height - 100);
    ctx.stroke();
}

// ===============================
// éµç›¤äº‹ä»¶èˆ‡åˆ¤å®š
// ===============================
document.addEventListener('keydown', (e) => {
    if (!isPlaying) return;
    const key = e.key.toUpperCase();
    const lane = KEY_LIST.indexOf(key);
    if (lane === -1) return;
    keyHints[lane].classList.add('active');
    setTimeout(() => keyHints[lane].classList.remove('active'), 120);
    judgeNote(lane);
});

function judgeNote(lane) {
    const now = (performance.now() - startTime) / 1000;
    const settings = difficultySettings[currentDifficulty];
    const judgeLineY = canvas.height - 100;
    const noteHeight = 32;
    
    // å°‹æ‰¾ç•¶å‰å¯ä»¥æ“Šæ‰“çš„éŸ³ç¬¦
    for (let i = currentNoteIndex; i < notes.length; i++) {
        const note = notes[i];
        if (note.lane !== lane || note.hit) continue;
        
        // è¨ˆç®—éŸ³ç¬¦ä½ç½®
        const y = (now - note.time) * (180 / settings.noteSpeed) + 60;
        
        // æª¢æŸ¥æ˜¯å¦åœ¨åˆ¤å®šç¯„åœå…§
        const distanceFromJudgeLine = Math.abs(y - judgeLineY);
        
        if (distanceFromJudgeLine <= settings.judgementRange) {
            // åœ¨åˆ¤å®šç¯„åœå…§ï¼Œè¨ˆç®—åˆ¤å®šç­‰ç´š
            let judgeType = 'Miss';
            if (distanceFromJudgeLine <= settings.judgementRange * 0.3) {
                judgeType = 'Perfect';
            } else if (distanceFromJudgeLine <= settings.judgementRange * 0.7) {
                judgeType = 'Good';
            }
            
            hitNote(i, judgeType);
            return;
        }
        
        // å¦‚æœéŸ³ç¬¦é‚„æ²’åˆ°åˆ¤å®šç·šï¼Œå…è¨±é‡è¤‡å˜—è©¦
        if (y < judgeLineY - settings.judgementRange) {
            // éŸ³ç¬¦é‚„æ²’åˆ°ï¼Œä¸æ‰£åˆ†ï¼Œå¯ä»¥é‡è¤‡æŒ‰
            return;
        }
        
        // å¦‚æœéŸ³ç¬¦å·²ç¶“è¶…éåˆ¤å®šç·šå¤ªå¤šï¼Œç®— Miss
        if (y > judgeLineY + settings.judgementRange) {
            missNote();
            note.hit = true;
            if (i === currentNoteIndex) currentNoteIndex++;
            return;
        }
    }
    
    // æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„éŸ³ç¬¦ï¼Œç®— Miss
    missNote();
}

function hitNote(index, type) {
    const settings = difficultySettings[currentDifficulty];
    notes[index].hit = true;
    notes[index].anim = 0; // å•Ÿå‹•å‹•ç•«
    
    // æ›´æ–° currentNoteIndex
    if (index === currentNoteIndex) {
        while (notes[currentNoteIndex] && notes[currentNoteIndex].hit) currentNoteIndex++;
    }
    
    // è¨ˆç®—åˆ†æ•¸
    let addScore = 0;
    switch (type) {
        case 'Perfect':
            addScore = settings.perfectScore;
            break;
        case 'Good':
            addScore = settings.goodScore;
            break;
        case 'Miss':
            addScore = settings.missScore;
            break;
    }
    
    score += addScore;
    combo++;
    maxCombo = Math.max(combo, maxCombo);
    
    scoreDisplay.textContent = `åˆ†æ•¸ï¼š${score}`;
    comboDisplay.textContent = `${type}! Combo x${combo}`;
    
    // æ ¹æ“šåˆ¤å®šé¡å‹è¨­å®šé¡è‰²
    switch (type) {
        case 'Perfect':
            comboDisplay.style.color = '#ffb347';
            break;
        case 'Good':
            comboDisplay.style.color = '#4ecdc4';
            break;
        case 'Miss':
            comboDisplay.style.color = '#ff6f91';
            break;
    }
    
    // Combo/åˆ†æ•¸ é–ƒçˆå‹•ç•«
    scoreDisplay.style.textShadow = '0 0 16px #fff, 0 0 32px #0ff';
    comboDisplay.style.transform = 'scale(1.3)';
    setTimeout(() => {
        scoreDisplay.style.textShadow = '';
        comboDisplay.style.transform = 'scale(1)';
    }, 180);
}

function missNote() {
    combo = 0;
    comboDisplay.textContent = 'Miss!';
    comboDisplay.style.color = '#ff6f91';
    comboDisplay.style.transform = 'scale(1.3)';
    setTimeout(() => comboDisplay.style.transform = 'scale(1)', 180);
}

// ===============================
// éŠæˆ²çµæŸèˆ‡åˆ†æ•¸çµç®—
// ===============================
function endGame() {
    isPlaying = false;
    cancelAnimationFrame(animationId);
    if (endTimer) {
        clearTimeout(endTimer);
        endTimer = null;
    }
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // åœæ­¢éŠæˆ²éŸ³æ¨‚ï¼Œæ¢å¾©èƒŒæ™¯éŸ³æ¨‚
    audioManager.resumeBgm();
    
    // å¢åŠ éŠæˆ²æ¬¡æ•¸
    gamePlayCount++;
    
    let grade = 'C';
    if (score >= 12000) grade = 'S';
    else if (score >= 9000) grade = 'A';
    else if (score >= 6000) grade = 'B';
    const timerDisplay = document.getElementById('timer-display');
    if (timerDisplay) timerDisplay.textContent = `å‰©é¤˜ï¼š0.0 ç§’`;
    finalScore.textContent = `åˆ†æ•¸ï¼š${score}ï¼ˆæœ€å¤§Comboï¼š${maxCombo}ï¼Œæœ¬å±€60ç§’ï¼‰`;
    finalGrade.textContent = `ç­‰ç´šï¼š${grade}`;
    showScreen('result');
}

// ===============================
// è¼”åŠ©ï¼šè‡ªå‹• Miss è¶…æ™‚éŸ³ç¬¦
// ===============================
setInterval(() => {
    if (!isPlaying) return;
    const now = (performance.now() - startTime) / 1000;
    const settings = difficultySettings[currentDifficulty];
    const noteHeight = 32;
    const judgeLineY = canvas.height - 100;
    
    for (let i = currentNoteIndex; i < notes.length; i++) {
        const note = notes[i];
        if (note.hit) continue;
        
        // è¨ˆç®—éŸ³ç¬¦ä½ç½®
        const y = (now - note.time) * (180 / settings.noteSpeed) + 60;
        
        // å¦‚æœéŸ³ç¬¦è¶…éåˆ¤å®šç·šå¤ªå¤šï¼Œè‡ªå‹• Miss
        if (y > judgeLineY + settings.judgementRange + noteHeight) {
            missNote();
            note.hit = true;
            if (i === currentNoteIndex) currentNoteIndex++;
        } else {
            break;
        }
    }
}, 60);

// ===============================
// éš±è—é›£åº¦è§£é–æª¢æŸ¥
// ===============================
function checkHiddenDifficulty() {
    const hiddenDifficultyBtn = document.querySelector('.hidden-difficulty');
    if (hiddenDifficultyBtn) {
        if (gamePlayCount >= 3) {
            hiddenDifficultyBtn.style.display = 'inline-block';
            // æ·»åŠ ç‰¹æ®Šæ•ˆæœ
            hiddenDifficultyBtn.style.animation = 'glow 2s ease-in-out infinite alternate';
        } else {
            hiddenDifficultyBtn.style.display = 'none';
        }
    }
}

// ===============================
// é›£åº¦åˆ‡æ›
// ===============================
function setDifficulty(diff) {
    currentDifficulty = diff;
    difficultyBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.difficulty === diff);
    });
    updateStartBtnState();
}
difficultyBtns.forEach(btn => {
    btn.addEventListener('click', () => setDifficulty(btn.dataset.difficulty));
});
if (songSelect) {
    songSelect.addEventListener('change', () => {
        selectedSong = songSelect.value;
        updateStartBtnState();
    });
}

// ===============================
// æ­Œæ›²å¡ç‰‡äº’å‹•
// ===============================
songCards.forEach(card => {
    card.addEventListener('click', () => {
        songCards.forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        selectedSong = card.getAttribute('data-song');
        
        // ä½¿ç”¨ audioManager æ’­æ”¾é è¦½éŸ³æ¨‚
        audioManager.playPreview(selectedSong);
        
        updateStartBtnState();
    });
});

// ===============================
// åˆå§‹åŒ–
// ===============================
showScreen('select');
resizeCanvas();
// æª¢æŸ¥éš±è—é›£åº¦è§£é–ç‹€æ…‹
checkHiddenDifficulty();
// é–‹å§‹æ’­æ”¾ä¸»é¸å–®èƒŒæ™¯éŸ³æ¨‚
audioManager.playBgm();
// ä¸é è¨­é›£åº¦èˆ‡æ­Œæ›²ï¼Œéœ€ç”¨æˆ¶é¸æ“‡

// è®“é–‹å§‹æŒ‰éˆ•åªæœ‰åœ¨é¸æ“‡äº†éŸ³æ¨‚å’Œé›£åº¦å¾Œæ‰å¯æŒ‰
function updateStartBtnState() {
    if (startBtn) {
        startBtn.disabled = !(selectedSong && currentDifficulty);
        startBtn.classList.toggle('disabled', startBtn.disabled);
    }
}

// åˆå§‹åŒ–æ™‚æŒ‰éˆ•ä¸å¯æŒ‰
updateStartBtnState();

if (confirmBtn) confirmBtn.addEventListener('click', () => {
    // ä½¿ç”¨ showScreen å‡½æ•¸æ­£ç¢ºåˆ‡æ›ç•«é¢ï¼Œé¿å…è·‘ç‰ˆ
    showScreen('select');
    // åœæ­¢è©¦è½éŸ³æ¨‚ï¼Œæ¢å¾©èƒŒæ™¯éŸ³æ¨‚
    audioManager.stopPreview();
    // æª¢æŸ¥éš±è—é›£åº¦è§£é–
    checkHiddenDifficulty();
    // é‡è¨­é¸æ“‡ç‹€æ…‹
    selectedSong = null;
    currentDifficulty = null;
    // å–æ¶ˆæ‰€æœ‰ song-card/difficulty-btn çš„ active æ¨£å¼
    document.querySelectorAll('.song-card.active').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.difficulty-btn.active').forEach(el => el.classList.remove('active'));
    // ç¦ç”¨é–‹å§‹æŒ‰éˆ•
    updateStartBtnState();
}); 